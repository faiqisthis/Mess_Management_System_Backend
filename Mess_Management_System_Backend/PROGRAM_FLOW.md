# ?? Mess Management System - Program Flow Documentation

## ?? Table of Contents
1. [Application Architecture](#application-architecture)
2. [Startup Flow](#startup-flow)
3. [Request Processing Pipeline](#request-processing-pipeline)
4. [Authentication & Authorization](#authentication--authorization)
5. [API Endpoints](#api-endpoints)
6. [Security Layers](#security-layers)
7. [Common Request Flows](#common-request-flows)

---

## ??? Application Architecture

```
???????????????????????????????????????????????????????????????
?                    ASP.NET Core Web API                     ?
?                          (.NET 8)                           ?
???????????????????????????????????????????????????????????????
                            ?
        ?????????????????????????????????????????
        ?                   ?                   ?
   ???????????        ?????????????      ?????????????
   ?Controllers?       ? Middleware ?      ?  Services ?
   ?           ?       ?            ?      ?           ?
   ? • Auth    ?       ? • CORS     ?      ? • User    ?
   ? • Users   ?       ? • Auth     ?      ? • JWT     ?
   ???????????        ? • Ownership?      ?????????????
        ?             ??????????????            ?
        ?                   ?                   ?
        ?????????????????????????????????????????
                            ?
                      ?????????????
                      ?   Models  ?
                      ?           ?
                      ? • User    ?
                      ? • Requests?
                      ?????????????
                            ?
                      ?????????????
                      ?  Database ?
                      ?           ?
                      ? SQL Server?
                      ?????????????
```

---

## ?? Startup Flow

### 1. Program.cs Execution Order

```csharp
// ========================================
// STEP 1: Build Configuration
// ========================================
var builder = WebApplication.CreateBuilder(args);

// ========================================
// STEP 2: Register Services (Dependency Injection)
// ========================================

// 2a. Database Context
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(connectionString));
// ? Registers DbContext for data access
// ? Scoped lifetime (one per request)

// 2b. Password Hashing Service
builder.Services.AddScoped<IPasswordHasher<User>, PasswordHasher<User>>();
// ? Hashes passwords securely using PBKDF2
// ? Verifies passwords during login

// 2c. JWT Token Service
builder.Services.AddScoped<IJwtService, JwtService>();
// ? Generates JWT tokens after successful login
// ? Tokens contain user ID, email, and role

// 2d. User Business Logic Service
builder.Services.AddScoped<IUserService, UserService>();
// ? Handles all user operations (CRUD, auth)
// ? Interfaces allow for easy testing and swapping

// 2e. Authentication Configuration
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options => { ... });
// ? Configures JWT token validation
// ? Validates: Issuer, Audience, Lifetime, Signature

// 2f. Authorization
builder.Services.AddAuthorization();
// ? Enables role-based authorization
// ? Works with [Authorize(Roles = "Admin")] attributes

// 2g. Controllers
builder.Services.AddControllers();
// ? Registers all API controllers

// 2h. CORS Policy
builder.Services.AddCors(options => { ... });
// ? Allows frontend (localhost:3000) to access API
// ? Prevents browser security errors

// ========================================
// STEP 3: Build Application
// ========================================
var app = builder.Build();

// ========================================
// STEP 4: Configure Middleware Pipeline
// ========================================

// Order is CRITICAL! Each middleware processes request in order

app.UseDeveloperExceptionPage();     // [1] Show detailed errors (dev only)
app.UseHttpsRedirection();           // [2] Redirect HTTP ? HTTPS
app.UseCors("AllowFrontend");        // [3] Enable CORS
app.UseAuthentication();             // [4] Validate JWT tokens
app.UseAuthorization();              // [5] Check permissions
app.UseUserOwnershipValidation();    // [6] Custom ownership check
app.MapControllers();                // [7] Route to controllers

// ========================================
// STEP 5: Run Application
// ========================================
app.Run();
// ? Starts listening for HTTP requests
// ? Application is now running ?
```

---

## ?? Request Processing Pipeline

Every HTTP request flows through this pipeline:

```
???????????????????????????????????????????????????????????????
?                    Incoming HTTP Request                    ?
?  Example: POST /api/auth/login                              ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  [1] Developer Exception Page (Development Only)            ?
?  ? Catches and displays detailed error information          ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  [2] HTTPS Redirection Middleware                           ?
?  ? Redirects HTTP requests to HTTPS                         ?
?  ? Ensures secure communication                             ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  [3] CORS Middleware                                        ?
?  ? Check: Is request from allowed origin?                  ?
?  ? Allowed: http://localhost:3000                          ?
?  ? Allows: Any header, any method                          ?
?  ? Blocks: Requests from other origins                    ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  [4] Authentication Middleware                              ?
?  ? Extracts JWT token from Authorization header            ?
?  ? Validates token signature and expiration                ?
?  ? Extracts claims (User ID, Email, Role)                  ?
?  ? Sets HttpContext.User with claims                       ?
?  ? If valid: User is authenticated                         ?
?  ? If invalid/missing: User is anonymous                  ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  [5] Authorization Middleware                               ?
?  ? Checks [Authorize] attributes on endpoints              ?
?  ? Validates user has required role                        ?
?  ? If authorized: Continue                                 ?
?  ? If not: Return 401 Unauthorized or 403 Forbidden       ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  [6] User Ownership Validation Middleware (CUSTOM)          ?
?  ? For /api/users/{id} endpoints only                      ?
?  ? Compares logged-in user ID with route {id}              ?
?  ? Validates for: PUT, PATCH, DELETE, /change-password     ?
?  ? If same user or Admin: Continue                         ?
?  ? If different user: Return 403 Forbidden                ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  [7] Controller Routing                                     ?
?  ? Maps request to appropriate controller action           ?
?  ? Deserializes JSON body to C# objects                    ?
?  ? Executes controller method                              ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  [8] Service Layer                                          ?
?  ? Executes business logic                                 ?
?  ? Interacts with database via DbContext                   ?
?  ? Returns result to controller                            ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  [9] Response Generation                                    ?
?  ? Controller returns IActionResult                         ?
?  ? ASP.NET serializes to JSON                              ?
?  ? Sets HTTP status code                                   ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?                    HTTP Response to Client                  ?
?  Example: 200 OK with JSON body                             ?
???????????????????????????????????????????????????????????????
```

---

## ?? Authentication & Authorization

### JWT Token Flow

```
???????????????????????????????????????????????????????????????
?                      1. User Login                          ?
???????????????????????????????????????????????????????????????
                      ?
POST /api/auth/login  ?
{                     ?
  email: "user@...",  ?
  password: "..."     ?
}                     ?
                      ?
???????????????????????????????????????????????????????????????
?  UserService.Authenticate()                                 ?
?  1. Find user by email                                      ?
?  2. Verify password hash                                    ?
?  3. Check if user is active                                 ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  JwtService.GenerateToken()                                 ?
?  Creates JWT with:                                          ?
?  • NameIdentifier (User ID)                                 ?
?  • Email                                                    ?
?  • Role (Student/Teacher/Admin)                             ?
?  • Expiry time                                              ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  Response: 200 OK                                           ?
?  {                                                          ?
?    "userId": 1,                                             ?
?    "email": "user@example.com",                             ?
?    "role": "Student",                                       ?
?    "token": "eyJhbGciOiJIUzI1NiIs..."                       ?
?  }                                                          ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  2. Client Stores Token                                     ?
?  ? localStorage.setItem('token', response.token)            ?
???????????????????????????????????????????????????????????????
                      ?
                      ?
???????????????????????????????????????????????????????????????
?  3. Subsequent Requests Include Token                       ?
?  Authorization: Bearer eyJhbGciOiJIUzI1NiIs...              ?
???????????????????????????????????????????????????????????????
```

### Role-Based Authorization

| Role | Permissions |
|------|-------------|
| **Student** | • View own profile<br>• Change own password<br>• Register |
| **Teacher** | • View own profile<br>• Change own password<br>• Register |
| **Admin** | • All Student/Teacher permissions<br>• View all users<br>• Update any user<br>• Delete any user<br>• Change anyone's password |

---

## ?? API Endpoints

### Authentication Endpoints

| Endpoint | Method | Auth | Purpose | Request Body | Response |
|----------|--------|------|---------|--------------|----------|
| `/api/auth/login` | POST | ? None | User login | `LoginRequest` | `AuthResponse` with JWT |
| `/api/auth/register` | POST | ? None | User registration | `User` | Created `User` |

### User Management Endpoints

| Endpoint | Method | Auth | Purpose | Who Can Access |
|----------|--------|------|---------|----------------|
| `/api/users` | GET | ? Admin | Get all users | Admin only |
| `/api/users/{id}` | GET | ? None | Get user by ID | Anyone |
| `/api/users` | POST | ? None | Create user | Anyone (registration) |
| `/api/users/{id}` | PUT | ? Admin | Update user | Admin only |
| `/api/users/{id}/change-password` | POST | ? Owner/Admin | Change password | User themselves or Admin |
| `/api/users/{id}` | DELETE | ? Admin | Delete user | Admin only |

---

## ??? Security Layers

The application has **4 layers of security**:

```
???????????????????????????????????????????????????????????????
?                      Security Layers                        ?
???????????????????????????????????????????????????????????????
?                                                             ?
?  ???????????????????????????????????????????????????????   ?
?  ? Layer 1: Authentication Middleware                  ?   ?
?  ? Question: Is the user logged in?                    ?   ?
?  ? Check: JWT token valid and not expired?             ?   ?
?  ? Result: Sets HttpContext.User with claims           ?   ?
?  ???????????????????????????????????????????????????????   ?
?                         ?                                   ?
?  ???????????????????????????????????????????????????????   ?
?  ? Layer 2: Authorization Middleware                   ?   ?
?  ? Question: Does user have the right role?            ?   ?
?  ? Check: [Authorize(Roles = "Admin")] attributes      ?   ?
?  ? Result: 403 if not authorized                       ?   ?
?  ???????????????????????????????????????????????????????   ?
?                         ?                                   ?
?  ???????????????????????????????????????????????????????   ?
?  ? Layer 3: User Ownership Middleware (CUSTOM)         ?   ?
?  ? Question: Is user accessing their own resource?     ?   ?
?  ? Check: Token User ID == Route {id}?                 ?   ?
?  ? Result: 403 if accessing another user's resource    ?   ?
?  ???????????????????????????????????????????????????????   ?
?                         ?                                   ?
?  ???????????????????????????????????????????????????????   ?
?  ? Layer 4: Service Layer Business Logic               ?   ?
?  ? Question: Is the operation valid?                   ?   ?
?  ? Check: Password correct? Email unique?              ?   ?
?  ? Result: 400 Bad Request if validation fails         ?   ?
?  ???????????????????????????????????????????????????????   ?
?                                                             ?
???????????????????????????????????????????????????????????????
```

---

## ?? Common Request Flows

### Flow 1: User Registration

```
Client                    Controller              Service               Database
  ?                          ?                       ?                     ?
  ?  POST /api/auth/register ?                       ?                     ?
  ??????????????????????????>?                       ?                     ?
  ?  {                       ?                       ?                     ?
  ?    firstName: "John",    ?                       ?                     ?
  ?    lastName: "Doe",      ?                       ?                     ?
  ?    email: "john@...",    ?  CreateUserAsync()    ?                     ?
  ?    password: "Pass123",  ???????????????????????>?                     ?
  ?    role: 0               ?                       ?                     ?
  ?  }                       ?                       ?  Check email unique ?
  ?                          ?                       ?????????????????????>?
  ?                          ?                       ?                     ?
  ?                          ?                       ?<?????????????????????
  ?                          ?                       ?  Email OK           ?
  ?                          ?                       ?                     ?
  ?                          ?                       ?  Hash password      ?
  ?                          ?                       ?  (PBKDF2)           ?
  ?                          ?                       ?                     ?
  ?                          ?                       ?  INSERT user        ?
  ?                          ?                       ?????????????????????>?
  ?                          ?                       ?                     ?
  ?                          ?  Return User          ?<?????????????????????
  ?                          ?<???????????????????????                     ?
  ?                          ?                       ?                     ?
  ?  201 Created             ?                       ?                     ?
  ?<??????????????????????????                       ?                     ?
  ?  {                       ?                       ?                     ?
  ?    id: 5,                ?                       ?                     ?
  ?    firstName: "John",    ?                       ?                     ?
  ?    email: "john@...",    ?                       ?                     ?
  ?    role: 0               ?                       ?                     ?
  ?    // NO password!       ?                       ?                     ?
  ?  }                       ?                       ?                     ?
  ?                          ?                       ?                     ?
```

### Flow 2: User Login

```
Client                    Controller              Service               Database
  ?                          ?                       ?                     ?
  ?  POST /api/auth/login    ?                       ?                     ?
  ??????????????????????????>?                       ?                     ?
  ?  {                       ?                       ?                     ?
  ?    email: "john@...",    ?  Authenticate()       ?                     ?
  ?    password: "Pass123"   ???????????????????????>?                     ?
  ?  }                       ?                       ?                     ?
  ?                          ?                       ?  SELECT user        ?
  ?                          ?                       ?  WHERE email=...    ?
  ?                          ?                       ?????????????????????>?
  ?                          ?                       ?                     ?
  ?                          ?                       ?<?????????????????????
  ?                          ?                       ?  User found         ?
  ?                          ?                       ?                     ?
  ?                          ?                       ?  Verify password    ?
  ?                          ?                       ?  hash matches       ?
  ?                          ?                       ?                     ?
  ?                          ?                       ?  Generate JWT       ?
  ?                          ?                       ?  (JwtService)       ?
  ?                          ?                       ?                     ?
  ?                          ?  AuthResponse         ?                     ?
  ?                          ?<???????????????????????                     ?
  ?                          ?                       ?                     ?
  ?  200 OK                  ?                       ?                     ?
  ?<??????????????????????????                       ?                     ?
  ?  {                       ?                       ?                     ?
  ?    userId: 5,            ?                       ?                     ?
  ?    email: "john@...",    ?                       ?                     ?
  ?    role: "Student",      ?                       ?                     ?
  ?    token: "eyJhbG..."    ?                       ?                     ?
  ?  }                       ?                       ?                     ?
  ?                          ?                       ?                     ?
```

### Flow 3: Change Password (With Security Checks)

```
Client                    Middleware             Controller              Service
  ?                          ?                       ?                     ?
  ?  POST /users/5/change-   ?                       ?                     ?
  ?  password                ?                       ?                     ?
  ?  Auth: Bearer <token-5>  ?                       ?                     ?
  ??????????????????????????>?                       ?                     ?
  ?  {                       ?                       ?                     ?
  ?    currentPassword:"...", ?                      ?                     ?
  ?    newPassword: "..."    ?                       ?                     ?
  ?  }                       ?                       ?                     ?
  ?                          ?                       ?                     ?
  ?                     [Auth Middleware]            ?                     ?
  ?                          ?                       ?                     ?
  ?                          ?  Validate JWT         ?                     ?
  ?                          ?  Extract claims:      ?                     ?
  ?                          ?  • User ID: 5         ?                     ?
  ?                          ?  • Role: Student      ?                     ?
  ?                          ?                       ?                     ?
  ?                  [Ownership Middleware]          ?                     ?
  ?                          ?                       ?                     ?
  ?                          ?  Check ownership:     ?                     ?
  ?                          ?  Token ID (5) ==      ?                     ?
  ?                          ?  Route ID (5)? ?      ?                     ?
  ?                          ?                       ?                     ?
  ?                          ?  Route to controller  ?                     ?
  ?                          ???????????????????????>?                     ?
  ?                          ?                       ?                     ?
  ?                          ?                       ? ChangePasswordAsync()
  ?                          ?                       ?????????????????????>?
  ?                          ?                       ?                     ?
  ?                          ?                       ?  1. Find user (5)   ?
  ?                          ?                       ?  2. Verify current  ?
  ?                          ?                       ?     password        ?
  ?                          ?                       ?  3. Hash new pass   ?
  ?                          ?                       ?  4. Save to DB      ?
  ?                          ?                       ?                     ?
  ?                          ?                       ?  Return true        ?
  ?                          ?                       ?<?????????????????????
  ?                          ?                       ?                     ?
  ?  200 OK                  ?                       ?                     ?
  ?<??????????????????????????????????????????????????                     ?
  ?  {                       ?                       ?                     ?
  ?    message: "Password    ?                       ?                     ?
  ?    changed successfully" ?                       ?                     ?
  ?  }                       ?                       ?                     ?
  ?                          ?                       ?                     ?
```

### Flow 4: Unauthorized Password Change Attempt

```
Client                    Middleware             Controller
  ?                          ?                       ?
  ?  POST /users/10/change-  ?                       ?
  ?  password                ?                       ?
  ?  Auth: Bearer <token-5>  ?                       ?
  ??????????????????????????>?                       ?
  ?                          ?                       ?
  ?                     [Auth Middleware]            ?
  ?                          ?                       ?
  ?                          ?  Validate JWT         ?
  ?                          ?  Extract claims:      ?
  ?                          ?  • User ID: 5         ?
  ?                          ?  • Role: Student      ?
  ?                          ?                       ?
  ?                  [Ownership Middleware]          ?
  ?                          ?                       ?
  ?                          ?  Check ownership:     ?
  ?                          ?  Token ID (5) ==      ?
  ?                          ?  Route ID (10)? ?    ?
  ?                          ?                       ?
  ?                          ?  User 5 trying to     ?
  ?                          ?  change User 10's     ?
  ?                          ?  password!            ?
  ?                          ?                       ?
  ?  403 Forbidden           ?                       ?
  ?<??????????????????????????                       ?
  ?  {                       ?                       ?
  ?    message: "You are not ?                       ?
  ?    authorized to modify  ?                       ?
  ?    this resource"        ?                       ?
  ?  }                       ?                       ?
  ?                          ?                       ?
  ?  ? BLOCKED!             ?    Never reaches      ?
  ?                          ?    controller         ?
```

---

## ?? Key Components Explained

### 1. Dependency Injection (DI)

**What it is:** A design pattern where objects receive their dependencies from external sources rather than creating them.

**Why we use it:**
- ? Easier testing (can inject mock services)
- ? Loose coupling (change implementations easily)
- ? Better code organization

**Example:**
```csharp
// Register service
builder.Services.AddScoped<IUserService, UserService>();

// Use in controller
public class UsersController : ControllerBase
{
    private readonly IUserService _userService;
    
    // Constructor injection - ASP.NET provides the service automatically
    public UsersController(IUserService userService)
    {
        _userService = userService;
    }
}
```

### 2. Middleware Pipeline

**What it is:** Chain of components that process HTTP requests and responses.

**Key points:**
- ?? **Order matters!** Authentication must come before Authorization
- Each middleware can:
  - Process the request
  - Pass to next middleware
  - Short-circuit (stop pipeline)
  - Process the response

**Example:**
```csharp
app.UseAuthentication();  // MUST come before Authorization
app.UseAuthorization();   // Needs authenticated user from previous middleware
```

### 3. JWT (JSON Web Token)

**Structure:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI1IiwiZW1haWwiOiJqb2huQGV4YW1wbGUuY29tIiwicm9sZSI6IlN0dWRlbnQifQ.signature
?                                     ?                                                                        ?
???????????? Header ???????????????????????????????????????? Payload ??????????????????????????????????????????? Signature ??
```

**Contains:**
- Header: Algorithm (HS256)
- Payload: User claims (ID, email, role)
- Signature: Verifies token hasn't been tampered with

### 4. Password Hashing

**Never store plain passwords!**

```csharp
// Registration
var passwordHash = _passwordHasher.HashPassword(user, plainPassword);
// Stores: "$2a$11$N9qo8uJTWheP..." (irreversible)

// Login
var verification = _passwordHasher.VerifyHashedPassword(user, storedHash, plainPassword);
// Hashes the plain password and compares
```

---

## ?? Design Patterns Used

| Pattern | Where Used | Purpose |
|---------|------------|---------|
| **Dependency Injection** | Throughout | Loose coupling, testability |
| **Repository Pattern** | DbContext + Services | Data access abstraction |
| **Interface Segregation** | IUserService, IJwtService | Contract-based programming |
| **Middleware Pipeline** | Program.cs | Chain of responsibility |
| **Claims-Based Auth** | JWT + Middleware | Identity & authorization |
| **DTO Pattern** | ? Removed | We use models directly (simpler) |

---

## ?? Database Schema

```sql
-- Users Table
CREATE TABLE Users (
    Id INT PRIMARY KEY IDENTITY(1,1),
    FirstName NVARCHAR(100) NOT NULL,
    LastName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(MAX) NOT NULL,
    PasswordHash NVARCHAR(MAX) NOT NULL,
    Role INT NOT NULL,              -- 0=Student, 1=Teacher, 2=Admin
    IsActive BIT NOT NULL DEFAULT 1,
    CreatedAt DATETIME2 NOT NULL,
    RollNumber NVARCHAR(MAX) NULL,
    RoomNumber NVARCHAR(MAX) NULL,
    ContactNumber NVARCHAR(MAX) NULL
);

-- Other tables (Menu, Attendance, Bills) follow similar pattern
```

---

## ?? Important Security Notes

### ? Security Measures Implemented:

1. **Password Hashing**: PBKDF2 with salt (via ASP.NET Identity)
2. **JWT Tokens**: Signed and time-limited
3. **HTTPS**: All traffic encrypted
4. **Role-Based Access**: Admin vs Student/Teacher
5. **Ownership Validation**: Users can only modify their own resources
6. **CORS**: Only allowed frontend can access API
7. **Password Never Returned**: `[JsonIgnore]` on PasswordHash

### ?? Best Practices:

- Never log passwords or tokens
- Store JWT secret in secure configuration (Azure Key Vault in production)
- Use HTTPS in production
- Implement rate limiting (future enhancement)
- Add refresh tokens for better UX (future enhancement)

---

## ?? Quick Reference

### Testing the API

**1. Register a new user:**
```bash
POST http://localhost:5000/api/auth/register
Content-Type: application/json

{
  "firstName": "John",
  "lastName": "Doe",
  "email": "john@example.com",
  "password": "Password123",
  "role": 0
}
```

**2. Login:**
```bash
POST http://localhost:5000/api/auth/login
Content-Type: application/json

{
  "email": "john@example.com",
  "password": "Password123"
}

# Response includes token - copy it!
```

**3. Use token in subsequent requests:**
```bash
POST http://localhost:5000/api/users/5/change-password
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
Content-Type: application/json

{
  "currentPassword": "Password123",
  "newPassword": "NewPassword456"
}
```

---

## ?? Further Reading

- [ASP.NET Core Middleware](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/)
- [JWT Authentication](https://jwt.io/introduction)
- [Dependency Injection in .NET](https://docs.microsoft.com/en-us/dotnet/core/extensions/dependency-injection)
- [Entity Framework Core](https://docs.microsoft.com/en-us/ef/core/)

---

**Last Updated:** 2024  
**Version:** 1.0  
**Author:** Mess Management System Team
